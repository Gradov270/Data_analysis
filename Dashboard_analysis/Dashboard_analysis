import pandas as pd
from sqlalchemy import create_engine
import datetime

engine = create_engine(connection_string)

query = '''
            SELECT * FROM dash_visits
        '''
dash_visits = pd.io.sql.read_sql(query, con = engine) 

dash_visits.to_csv("dash_visits.csv", encoding='utf-8')

table = dash_visits.pivot_table(index=['item_topic', 'age_segment'], columns = 'dt', values = 'visits', aggfunc='sum')
table = table.reset_index()
sum_columns = list(table.drop(['item_topic', 'age_segment'], axis = 1).sum())
names = table.iloc[:, 0]
age = table.iloc[:, 1]
table = table.iloc[:, 2:]

for i in list(table.columns):
    print(table[i].sum())
    
for i in list(table.columns):
    table[i] = table[i]/table[i].sum()
  
table['item_topic'] = names
table['age_segment'] = age
table = table.melt(
    id_vars=['item_topic', 'age_segment'], value_vars=table.columns[:-2].tolist()
)

table.to_excel("percents_item_topics.xlsx", encoding='utf-16')
